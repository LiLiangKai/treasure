!function(){"use strict";function e(e=""){return(e=e.trim())?(e=e.replace(/[\-_\s]+(.)?/g,(function(e,t){return t?t.toUpperCase():""}))).slice(0,1).toLowerCase()+e.slice(1):e}function t(e=""){return e.slice(0,1).toUpperCase()+e.slice(1)}function i(e){return e?"int"===e||/^u?int/.test(e)?"number":"bool"===e?"boolean":/Array|array|list|List/.test(e)?e.replace(/\s+(Array|array|list|List)/,"[]"):e:"any"}const n=e=>navigator.clipboard.writeText(e),s=(e="div",t="")=>{const i=document.createElement(e);return i.style.cssText=t,i};function r(e){return(new DOMParser).parseFromString(e,"text/html")}const o=["field","type","description"],a=["value","description"];class l{constructor(e,t=!0){this.tableWrapDom=e,this.columns={},this.dataSource=[],this.domId=Date.now().toString(26).slice(-5)+Math.random().toString(26).slice(-5),e.setAttribute("data-uid",this.domId),t&&l.tsTableList.set(this.domId,this),window.BaseTsTable=l}init(){this.tsType||(this.initColums(),this.tsType=function(e){const t=Object.values(e||{});return o.every((e=>t.includes(e)))?"interface":!!a.every((e=>t.includes(e)))&&"enum"}(this.columns),!1!==this.tsType&&(this.initDataSource(),this.initTypeName()))}initColums(){const e=this.tableWrapDom.querySelector("tr");if(!e)return;e.querySelectorAll("th").forEach(((e,t)=>{const i=e.innerText.trim().toLowerCase();this.columns[t]=i}))}initDataSource(){(function(e){const t=e.classList.value;return Array.from(e.querySelectorAll("tr")).filter((i=>{let n=i.parentElement;for(;n;){if(n.classList.contains(t))return n===e;n=n.parentElement}return!0}))})(this.tableWrapDom).forEach((n=>{const s=Array.from(n.children).filter((e=>"td"===e.nodeName.toLowerCase()));if(!s.length)return;const r={};s.forEach(((n,s)=>{var o,a;const c=this.columns[s];if(!c)return;let p="";if(n.childElementCount){const t=n.querySelector(".table-wrap");if(t){const n=t.getAttribute("data-uid");if(n&&l.tsTableList.has(n)){const t=l.tsTableList.get(n);null==t||t.init(),p=`type:${function(t=[]){const n=[];return t.forEach((t=>{if(!t.field)return;let s=`${e(t.field)}?: ${i(t.type)}`;n.push(s)})),`{ ${n.join("; ")} }`}((null==t?void 0:t.dataSource)||[])}`}}else p=null===(a=n.innerText.split("\n")[0])||void 0===a?void 0:a.trim()}else p=null===(o=n.innerText)||void 0===o?void 0:o.trim();if("type"===c){const i=n.querySelector("a");if(i){const n=i.href.replace(/\#.*/,"");let s=i.innerText.trim();if(/[\-_\s]+(.)?/g.test(s)){let i=s;s=t(e(s)),p=p.replace(i,s)}-1!==location.href.indexOf(n)||l.referenceTypes.has(s)||l.referenceTypes.set(s,{href:n})}}r[c]=p.trim()})),this.dataSource.push(function(e={}){if((!e.type||/^(object|Object|obj|Obj)/.test(e.type))&&/^type\:/.test(e.description)){const t=e.description.replace("type:","");return e.type=e.type?e.type.replace(/object|Object|obj|Obj/,t):t,e.description="",e}if(/^type\:/.test(e.type))return e.type=e.type.replace("type:",""),e;return e}(r))}))}initTypeName(){if(this.tsType){let i=2,n=this.tableWrapDom;for(;i>0;){i--;const s=n.previousElementSibling;if(s){if(s.classList.contains("code"))break;let i=s.innerText.trim();if(i){/([a-zA-Z\s]+)/.test(i)&&(i=RegExp.$1),this.typeName=t(e(i));break}}if(n=s,!n)break}this.typeName&&/^[A-Za-z0-9]+$/g.test(this.typeName)||(this.typeName=`Type${t(this.domId)}`)}else this.typeName=""}updateTypeName(e){e&&(this.typeName=e)}generateTsType(){if(this.init(),!this.tsType)return"";if(l.typeMap.has(this.typeName))return l.typeMap.get(this.typeName);const t=function(t,n,s=[]){switch(t){case"interface":return function(t,n=[]){const s=[];return n.forEach((t=>{if(!t.field)return;let n=`${e(t.field)}?: ${i(t.type)}`;t.description&&(n+=` // ${t.description.replace(/\n/g,"")}`),s.push(n)})),`export interface ${t} {\n  ${s.join("\n  ")}\n}`}(n,s);case"enum":return function(e,t=[]){const i=[];return t.forEach((e=>{var t;(e.type||e.description)&&e.value&&i.push(`${(e.type||e.description).replace(/\s+/g,"_")} = ${t=e.value,isNaN(Number(t))?"true"===t||"false"!==t&&t:Number(t)}`)})),`export enum ${e} {\n  ${i.join(",\n  ")}\n}`}(n,s);default:return""}}(this.tsType,this.typeName,this.dataSource);return l.typeMap.set(this.typeName,t),t}static getAllReferenceTypeOrigin(){const e={};return l.referenceTypes.forEach((t=>{const{href:i,fetch:n}=t;!n&&(e[i]=i)})),Object.values(e)}static getAllReferenceTypes(){const e={};return l.referenceTypes.forEach(((t,i)=>{l.typeMap.has(i)&&(e[i]=l.typeMap.get(i))})),e}}l.typeMap=new Map,l.tsTableList=new Map,l.referenceTypes=new Map;class c extends l{constructor(e){super(e),this.tableWrapDom.addEventListener("mouseenter",this.handleMouseenter.bind(this)),this.tableWrapDom.addEventListener("mouseleave",this.handleMouseLeave.bind(this))}handleMouseenter(){if(this.tsType||this.init(),!1===this.tsType)return;this.triggerDom||this.initTrigger();const e=this.tableWrapDom.querySelector(".confluenceTable");this.triggerDom.innerText="copy",this.triggerDom.style.left=e.offsetWidth+"px",this.triggerDom.style.display="block"}handleMouseLeave(){this.triggerDom&&(this.triggerDom.style.display="none")}initTrigger(){this.tableWrapDom.style.position="relative",this.triggerDom=s("div","position:absolute;top:0px;z-index:10;background:#ddd;display:none;font-size:12px;padding:2px 5px;color:#666;border-radius:5px;cursor:pointer;"),this.triggerDom.addEventListener("click",(()=>{const e=this.generateTsType();n(e).then((()=>{this.triggerDom.innerText="copied"}))})),this.tableWrapDom.appendChild(this.triggerDom)}}const p=/^(GET|POST|Delete|PUT|get|post|delete|put)\s+\/api/;class h{constructor(){if(h.instance)return h.instance;this.init(),h.instance=this,window.tsapi=h.instance}init(){this.initApiDoms()}initApiDoms(){if(!this.apiDoms){this.apiDoms=function(){const e=document.querySelectorAll('div[data-macro-name="code"]'),t=[];return e.forEach((e=>{const i=e.innerText.trim();!i||i.split("\n").length>1||p.test(i)&&t.push(e)})),t}();for(let e=0;e<this.apiDoms.length;e++)this.handleApiDom(this.apiDoms[e])}}handleApiDom(i){if(!i)return;const n=function(t){const i=t.indexOf("/api");if(-1===i)return{};const n=[],s=t.indexOf("?"),r=t.slice(i,-1===s?t.length:s);let o=r;const a=/\:([a-z-_]+)/.exec(o);if(a&&a[1]){const t=e(a[1]);o=o.replace(a[0],`\${${t}}`),n.push({name:t,type:"string"})}return{url:o,originUrl:r,name:u(t),method:d(t),args:n}}(i.innerText.trim()),s=Object.assign({},n);let r=0,o=i.previousElementSibling;for(;o&&r<2;){if(/^h[1-6]$/.test(o.nodeName.toLowerCase())){const e=o.innerText.trim();if(!/request/.test(e.toLowerCase())){s.label=e;break}}o=o.previousElementSibling,r++}let a=i.nextElementSibling,l=!1;for(;a;){const e=a.innerText.trim();if(e){if(p.test(e))break;if(/response/.test(e.toLowerCase()))l=!0,a=a.nextElementSibling;else{if(a.classList.contains("table-wrap")){const e=new c(a);e.init(),e.updateTypeName(t(`${s.name}${l?"Response":"Request"}`));const i={typeName:e.typeName,typeDeclaration:e.generateTsType()};if(l){s.responseType=i;break}s.requestBody=i}a=a.nextElementSibling}}else a=a.nextElementSibling}i.ts=s}generateAllApiCode(){const e=[];return this.apiDoms.forEach((t=>{const i=t.ts;i&&e.push(function(e){var t;const{args:i=[],responseType:n,requestBody:s}=e,r=(null==i?void 0:i.map((e=>`${e.name}: ${e.type}`)))||[],o=[];let a="";(null==s?void 0:s.typeDeclaration)&&(r.push(`data: ${s.typeName}`),o.push(s.typeDeclaration),a="get"===e.method?"params: data":"data");(null==n?void 0:n.typeDeclaration)&&o.push(n.typeDeclaration);return`${o.length>0?"\n"+o.join("\n\n")+"\n":""}\n/**\n * ${e.label}\n * @method ${e.method}\n * @url ${e.originUrl} \n */\nexport async function ${e.name}(${r.join(", ")}): Promise<${(null==n?void 0:n.typeName)||"any"}> {\n  return request(\`${null===(t=e.url)||void 0===t?void 0:t.replace(/^\/api/,"")}\`, {\n    method: '${e.method}',${a?`\n\t\t${a},`:""}\n  })\n}`}(i))})),e.length>0&&e.unshift("import request from '@/utils/request'"),e.join("\n")}}function d(e){const t=p.exec(e);return t&&t[1]?t[1].toLowerCase():"get"}function u(t){const i=d(t),n=t.replace(/\?.+/,"").split("/").filter((e=>!/^\:/.test(e)));let s=n.length-1,r=e(`${i} ${n.slice(s).join(" ")}`);for(;h.apiNameMap.has(r)&&s>0;)s--,r=e(`${i} ${n.slice(s).join(" ")}`);return h.apiNameMap.set(r,1),r}h.apiNameMap=new Map;class f{initModal(){if(this.modal)return;this.modal=s("div","position:fixed;top:0;left:0;z-index:1000;width:100%;height:100%;display:none");const e=s("div","position:absolute;top:50%;left:40%;width:600px;height:80%;min-height:500px;padding:12px;background:#f5f5f5;border:1px solid #ddd;overflow:auto;transform:translate(-50%,-50%);");this.textarea=s("textarea","width:100%;height:100%;font-size:14px;resize:none;border:0;background:#f5f5f5;outline:none;"),this.textarea.readOnly=!0;const t=s("div","position:absolute;top:0px;right:0px;width:40px;height:30px;line-height:30px;font-size:20px;text-align:center;color:#666;background:#ddd;cursor:pointer;");t.innerText="X",t.addEventListener("click",(()=>{this.hidden()}));const i=s("div","position:absolute;top:31px;right:0px;width:40px;height:30px;line-height:30px;font-size:20px;text-align:center;color:#666;background:#ddd;cursor:pointer;");i.innerText="C",i.addEventListener("click",(()=>{n(this.textarea.value)})),e.appendChild(this.textarea),e.appendChild(t),e.appendChild(i),this.modal.appendChild(e),document.body.appendChild(this.modal)}initExtraWrap(){if(this.extraWrap)return;this.extraWrap=s("div","position:absolute;top:50%;right:0;width:400px;height:40%;min-height:400px;padding:12px;background:#f5f5f5;border:1px solid #ddd;overflow:auto;transform: translateY(-50%);"),this.extraTextarea=s("textarea","width:100%;height:100%;font-size:12px;resize:none;border:0;background:#f5f5f5;outline:none;"),this.extraTextarea.readOnly=!0;const e=s("div","position:absolute;top:0;right:0px;width:40px;height:30px;line-height:30px;font-size:20px;text-align:center;color:#666;background:#ddd;cursor:pointer;");e.innerText="C",e.addEventListener("click",(()=>{n(this.extraTextarea.value)})),this.extraWrap.appendChild(this.extraTextarea),this.extraWrap.appendChild(e),this.modal.appendChild(this.extraWrap)}show(){this.modal||this.initModal(),this.modal.style.display="block"}hidden(){this.modal&&(this.modal.style.display="none")}updateValue(e){this.textarea&&(this.textarea.value=e)}updateExtraValue(e){this.extraWrap||this.initExtraWrap(),this.extraTextarea&&(this.extraTextarea.value=e),this.extraWrap.style.display=e?"block":"none"}}class m{constructor(e){this.cbs={},this.worker=new Worker(e),this.worker.addEventListener("message",(e=>{const{event:t,data:i}=e.data;this.cbs[t]&&this.cbs[t].forEach((e=>{e(i)}))}))}on(e,t){if("function"!=typeof t)return;const i=this.cbs[e]||[];i.push(t),this.cbs[e]=i}emit(e,t){this.worker.postMessage({event:e,data:t})}destory(){this.worker&&this.worker.terminate()}}m.generateWorkerBlob=e=>{const t=new Blob([`~(${e.toString()})();`],{type:"text/javascript"});return window.URL.createObjectURL(t)};class y{constructor(){if(y.instance)return y.instance;this.initTsButton(),this.initTsApiButton(),y.instance=this}initTsButton(){this.tsButton=s("div","position:fixed;right:20px;bottom:20px;z-index:10;background:#ddd;font-size:12px;padding:2px 5px;color:#666;border-radius:5px;cursor:pointer;"),this.tsButton.innerText="生成ts",this.tsButton.addEventListener("click",this.handleButtonClick.bind(this)),document.body.appendChild(this.tsButton)}initTsApiButton(){this.tsApiButton=s("div","position:fixed;right:20px;bottom:45px;z-index:10;background:#ddd;font-size:12px;padding:2px 5px;color:#666;border-radius:5px;cursor:pointer;"),this.tsApiButton.innerText="生成api",this.tsApiButton.addEventListener("click",this.handleApiButtonClick.bind(this)),document.body.appendChild(this.tsApiButton)}initWorker(){this.worker||(this.worker=new m(m.generateWorkerBlob(g)),this.worker.on("fetchDocument:response",(e=>{if(!e)return;for(const t in e){r(e[t]).querySelectorAll(".table-wrap").forEach((e=>{new l(e,!1).generateTsType()})),c.referenceTypes.forEach(((e,i)=>{const{href:n}=e;n===t&&c.referenceTypes.set(i,Object.assign(Object.assign({},e),{fetch:!0}))}))}const t=y.generateAllReferenceTypes();this.modal.updateExtraValue(t)})))}handleButtonClick(){this.modal||(this.modal=new f),this.modal.show(),this.modal.updateValue(y.generateAllTsTypes()),this.fetchAllReferenceTypes()}handleApiButtonClick(){const e=new h;this.modal||(this.modal=new f),this.modal.show(),this.modal.updateValue(e.generateAllApiCode()),this.fetchAllReferenceTypes()}fetchAllReferenceTypes(){const e=c.getAllReferenceTypeOrigin();if(e.length>0)this.worker||this.initWorker(),this.worker.emit("fetchDocument",e);else{const e=y.generateAllReferenceTypes();this.modal.updateExtraValue(e)}}static generateAllTsTypes(){const e=[];return c.tsTableList.forEach((t=>{const i=t.generateTsType();i&&e.push(i)})),e.join("\n\n")}static generateAllReferenceTypes(){const e=c.getAllReferenceTypes();return Object.values(e).join("\n\n")}}function g(){function e(t){return new Promise((i=>{e.cache[t]?i(e.cache[t]):fetch(t,{method:"get"}).then((n=>{n.text().then((n=>{e.cache[t]=n?function(e){if(!e)return"";const t=e.split("\n").map((e=>e.trim())).filter((e=>e)),i=t.findIndex((e=>/id="main"/.test(e))),n=t.findIndex((e=>/<!-- \\#main -->/.test(e)));return-1===i||-1===n?e:t.slice(i,n+1).join("")}(n):"<div></div>",i(e.cache[t])})).catch((()=>{e.cache[t]="<div></div>",i(e.cache[t])}))})).catch((()=>{e.cache[t]="<div></div>",i(e.cache[t])}))}))}e.cache={};const t={fetchDocument:(t=[])=>new Promise(((i,n)=>{var s;(s=t.map((t=>e(t))),new Promise((e=>{const t=Array(s.length);let i=0;s.forEach(((n,r)=>{n.then((e=>{t[r]=e})).catch((()=>{t[r]=void 0})).finally((()=>{i++,i===s.length&&e(t)}))}))}))).then((e=>{i(e.reduce(((e,i,n)=>(e[t[n]]=i,e)),{}))}))}))};self.addEventListener("message",(e=>{const{data:i,event:n}=e.data;t[n]&&t[n](i).then((t=>{self.postMessage({event:`${e.data.event}:response`,data:t})}))}))}setTimeout((function(){if(!/confluence\.shopee\.io/.test(location.host))return;document.querySelectorAll(".table-wrap").forEach((e=>{new c(e)})),new y}),1e3)}();
