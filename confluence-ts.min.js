!function(){"use strict";function e(e=""){return e?(e=e.replace(/[\-_\s]+(.)?/g,(function(e,t){return t?t.toUpperCase():""}))).substr(0,1).toLowerCase()+e.substr(1):e}function t(e=""){return e.substr(0,1).toUpperCase()+e.substr(1)}function i(e){return e?"int"===e||/^u?int/.test(e)?"number":"bool"===e?"boolean":/Array|array/.test(e)?e.replace(/\s+(Array|array)/,"[]"):e:"any"}const r=e=>navigator.clipboard.writeText(e),n=(e="div",t="")=>{const i=document.createElement(e);return i.style.cssText=t,i};function s(e){return(new DOMParser).parseFromString(e,"text/html")}const a=["field","type","description"],o=["value","description"];class c{constructor(e,t=!0){this.tableWrapDom=e,this.columns={},this.dataSource=[],this.domId=Date.now().toString(26).slice(-5)+Math.random().toString(26).slice(-5),e.setAttribute("data-uid",this.domId),t&&c.tsTableList.set(this.domId,this),window.BaseTsTable=c}init(){this.tsType||(this.initColums(),this.tsType=function(e){const t=Object.values(e||{});return a.every((e=>t.includes(e)))?"interface":!!o.every((e=>t.includes(e)))&&"enum"}(this.columns),!1!==this.tsType&&(this.initDataSource(),this.initTypeName()))}initColums(){const e=this.tableWrapDom.querySelector("tr");if(!e)return;e.querySelectorAll("th").forEach(((e,t)=>{const i=e.innerText.trim().toLowerCase();this.columns[t]=i}))}initDataSource(){(function(e){const t=e.classList.value;return Array.from(e.querySelectorAll("tr")).filter((i=>{let r=i.parentElement;for(;r;){if(r.classList.contains(t))return r===e;r=r.parentElement}return!0}))})(this.tableWrapDom).forEach((t=>{const r=Array.from(t.children).filter((e=>"td"===e.nodeName.toLowerCase()));if(!r.length)return;const n={};r.forEach(((t,r)=>{var s,a;const o=this.columns[r];if(!o)return;let h="";if(t.childElementCount){const r=t.querySelector(".table-wrap");if(r){const t=r.getAttribute("data-uid");if(t&&c.tsTableList.has(t)){const r=c.tsTableList.get(t);null==r||r.init(),h=`type:${function(t=[]){const r=[];return t.forEach((t=>{if(!t.field)return;let n=`${e(t.field)}?: ${i(t.type)}`;r.push(n)})),`{ ${r.join("; ")} }`}((null==r?void 0:r.dataSource)||[])}`}}else h=null===(a=t.innerText.split("\n")[0])||void 0===a?void 0:a.trim()}else h=null===(s=t.innerText)||void 0===s?void 0:s.trim();if("type"===o){const e=t.querySelector("a");if(e){const t=e.href.replace(/\#.*/,""),i=e.innerText.trim().replace(/\s+/g,"");-1!==location.href.indexOf(t)||c.referenceTypes.has(i)||c.referenceTypes.set(i,{href:t})}}n[o]=h.trim()})),this.dataSource.push(function(e={}){if((!e.type||/^(object|Object)/.test(e.type))&&/^type\:/.test(e.description)){const t=e.description.replace("type:","");return e.type=e.type?e.type.replace(/object|Object/,t):t,e.description="",e}if(/^type\:/.test(e.type))return e.type=e.type.replace("type:",""),e;return e}(n))}))}initTypeName(){if(this.tsType){const i=this.tableWrapDom.previousElementSibling;i&&!i.classList.contains("code")&&(this.typeName=t(e(i.innerText.trim().replace(/\s+/g,"")))),this.typeName&&/^[A-Za-z0-9]+$/g.test(this.typeName)||(this.typeName=`Type${t(this.domId)}`)}else this.typeName=""}generateTsType(){if(this.init(),!this.tsType)return"";if(c.typeMap.has(this.typeName))return c.typeMap.get(this.typeName);const t=function(t,r,n=[]){switch(t){case"interface":return function(t,r=[]){const n=[];return r.forEach((t=>{if(!t.field)return;let r=`${e(t.field)}?: ${i(t.type)}`;t.description&&(r+=` // ${t.description.replace(/\n/g,"")}`),n.push(r)})),`export interface ${t} {\n  ${n.join("\n  ")}\n}`}(r,n);case"enum":return function(e,t=[]){const i=[];return t.forEach((e=>{var t;(e.type||e.description)&&e.value&&i.push(`${(e.type||e.description).replace(/\s+/g,"_")} = ${t=e.value,isNaN(Number(t))?"true"===t||"false"!==t&&t:Number(t)}`)})),`export enum ${e} {\n  ${i.join(",\n  ")}\n}`}(r,n);default:return""}}(this.tsType,this.typeName,this.dataSource);return c.typeMap.set(this.typeName,t),t}static getAllReferenceTypeOrigin(){const e={};return c.referenceTypes.forEach((t=>{const{href:i,fetch:r}=t;!r&&(e[i]=i)})),Object.values(e)}static getAllReferenceTypes(){const e={};return c.referenceTypes.forEach(((t,i)=>{c.typeMap.has(i)&&(e[i]=c.typeMap.get(i))})),e}}c.typeMap=new Map,c.tsTableList=new Map,c.referenceTypes=new Map;class h extends c{constructor(e){super(e),this.tableWrapDom.addEventListener("mouseenter",this.handleMouseenter.bind(this)),this.tableWrapDom.addEventListener("mouseleave",this.handleMouseLeave.bind(this))}handleMouseenter(){if(this.tsType||this.init(),!1===this.tsType)return;this.triggerDom||this.initTrigger();const e=this.tableWrapDom.querySelector(".confluenceTable");this.triggerDom.innerText="copy",this.triggerDom.style.left=e.offsetWidth+"px",this.triggerDom.style.display="block"}handleMouseLeave(){this.triggerDom&&(this.triggerDom.style.display="none")}initTrigger(){this.tableWrapDom.style.position="relative",this.triggerDom=n("div","position:absolute;top:0px;z-index:10;background:#ddd;display:none;font-size:12px;padding:2px 5px;color:#666;border-radius:5px;cursor:pointer;"),this.triggerDom.addEventListener("click",(()=>{const e=this.generateTsType();r(e).then((()=>{this.triggerDom.innerText="copied"}))})),this.tableWrapDom.appendChild(this.triggerDom)}}class l{initModal(){if(this.modal)return;this.modal=n("div","position:fixed;top:0;left:0;z-index:1000;width:100%;height:100%;display:none");const e=n("div","position:absolute;top:50%;left:40%;width:600px;height:80%;min-height:500px;padding:12px;background:#f5f5f5;border:1px solid #ddd;overflow:auto;transform:translate(-50%,-50%);");this.textarea=n("textarea","width:100%;height:100%;font-size:14px;resize:none;border:0;background:#f5f5f5;outline:none;"),this.textarea.readOnly=!0;const t=n("div","position:absolute;top:0px;right:0px;width:40px;height:30px;line-height:30px;font-size:20px;text-align:center;color:#666;background:#ddd;cursor:pointer;");t.innerText="X",t.addEventListener("click",(()=>{this.hidden()}));const i=n("div","position:absolute;top:31px;right:0px;width:40px;height:30px;line-height:30px;font-size:20px;text-align:center;color:#666;background:#ddd;cursor:pointer;");i.innerText="C",i.addEventListener("click",(()=>{r(this.textarea.value)})),e.appendChild(this.textarea),e.appendChild(t),e.appendChild(i),this.modal.appendChild(e),document.body.appendChild(this.modal)}initExtraWrap(){if(this.extraWrap)return;this.extraWrap=n("div","position:absolute;top:50%;right:0;width:400px;height:40%;min-height:400px;padding:12px;background:#f5f5f5;border:1px solid #ddd;overflow:auto;transform: translateY(-50%);"),this.extraTextarea=n("textarea","width:100%;height:100%;font-size:12px;resize:none;border:0;background:#f5f5f5;outline:none;"),this.extraTextarea.readOnly=!0;const e=n("div","position:absolute;top:0;right:0px;width:40px;height:30px;line-height:30px;font-size:20px;text-align:center;color:#666;background:#ddd;cursor:pointer;");e.innerText="C",e.addEventListener("click",(()=>{r(this.extraTextarea.value)})),this.extraWrap.appendChild(this.extraTextarea),this.extraWrap.appendChild(e),this.modal.appendChild(this.extraWrap)}show(){this.modal||this.initModal(),this.modal.style.display="block"}hidden(){this.modal&&(this.modal.style.display="none")}updateValue(e){this.textarea&&(this.textarea.value=e)}updateExtraValue(e){this.extraWrap||this.initExtraWrap(),this.extraTextarea&&(this.extraTextarea.value=e),this.extraWrap.style.display=e?"block":"none"}}class p{constructor(e){this.cbs={},this.worker=new Worker(e),this.worker.addEventListener("message",(e=>{const{event:t,data:i}=e.data;this.cbs[t]&&this.cbs[t].forEach((e=>{e(i)}))}))}on(e,t){if("function"!=typeof t)return;const i=this.cbs[e]||[];i.push(t),this.cbs[e]=i}emit(e,t){this.worker.postMessage({event:e,data:t})}destory(){this.worker&&this.worker.terminate()}}p.generateWorkerBlob=e=>{const t=new Blob([`~(${e.toString()})();`],{type:"text/javascript"});return window.URL.createObjectURL(t)};class d{constructor(){this.initTsButton(),document.body.appendChild(this.tsButton)}initTsButton(){this.tsButton=n("div","position:fixed;right:20px;bottom:20px;z-index:10;background:#ddd;font-size:12px;padding:2px 5px;color:#666;border-radius:5px;cursor:pointer;"),this.tsButton.innerText="生成ts",this.tsButton.addEventListener("click",this.handleButtonClick.bind(this))}initWorker(){this.worker||(this.worker=new p(p.generateWorkerBlob(u)),this.worker.on("fetchDocument:response",(e=>{if(!e)return;for(const t in e){s(e[t]).querySelectorAll(".table-wrap").forEach((e=>{new c(e,!1).generateTsType()})),h.referenceTypes.forEach(((e,i)=>{const{href:r}=e;r===t&&h.referenceTypes.set(i,Object.assign(Object.assign({},e),{fetch:!0}))}))}const t=d.generateAllReferenceTypes();this.modal.updateExtraValue(t)})))}handleButtonClick(){this.modal||(this.modal=new l),this.modal.show(),this.modal.updateValue(d.generateAllTsTypes());const e=h.getAllReferenceTypeOrigin();if(e.length>0)this.worker||this.initWorker(),this.worker.emit("fetchDocument",e);else{const e=d.generateAllReferenceTypes();this.modal.updateExtraValue(e)}}static generateAllTsTypes(){const e=[];return h.tsTableList.forEach((t=>{const i=t.generateTsType();e.push(i)})),e.join("\n\n")}static generateAllReferenceTypes(){const e=h.getAllReferenceTypes();return Object.values(e).join("\n\n")}}function u(){function e(t){return new Promise((i=>{e.cache[t]?i(e.cache[t]):fetch(t,{method:"get"}).then((r=>{r.text().then((r=>{e.cache[t]=r?function(e){if(!e)return"";const t=e.split("\n").map((e=>e.trim())).filter((e=>e)),i=t.findIndex((e=>/id="main"/.test(e))),r=t.findIndex((e=>/<!-- \\#main -->/.test(e)));return-1===i||-1===r?e:t.slice(i,r+1).join("")}(r):"<div></div>",i(e.cache[t])})).catch((()=>{e.cache[t]="<div></div>",i(e.cache[t])}))})).catch((()=>{e.cache[t]="<div></div>",i(e.cache[t])}))}))}e.cache={};const t={fetchDocument:(t=[])=>new Promise(((i,r)=>{var n;(n=t.map((t=>e(t))),new Promise((e=>{const t=Array(n.length);let i=0;n.forEach(((r,s)=>{r.then((e=>{t[s]=e})).catch((()=>{t[s]=void 0})).finally((()=>{i++,i===n.length&&e(t)}))}))}))).then((e=>{i(e.reduce(((e,i,r)=>(e[t[r]]=i,e)),{}))}))}))};self.addEventListener("message",(e=>{const{data:i,event:r}=e.data;t[r]&&t[r](i).then((t=>{self.postMessage({event:`${e.data.event}:response`,data:t})}))}))}setTimeout((function(){document.querySelectorAll(".table-wrap").forEach((e=>{new h(e)})),new d}),1e3)}();
