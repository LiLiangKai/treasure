!function(){"use strict";function e(e=""){return(e=e.trim())?(e=e.replace(/[\-_\/\\\s]+(.)?/g,(function(e,t){return t?t.toUpperCase():""}))).slice(0,1).toLowerCase()+e.slice(1):e}function t(e=""){return e.slice(0,1).toUpperCase()+e.slice(1)}function n(e){return e?"int"===e||/^u?int/.test(e)?"number":"bool"===e?"boolean":/Array|array|list|List/.test(e)?e.replace(/\s+(Array|array|list|List)/,"[]"):e:"any"}const i=e=>navigator.clipboard.writeText(e),s=(e="div",t="")=>{const n=document.createElement(e);return n.style.cssText=t,n};function a(e){return(new DOMParser).parseFromString(e,"text/html")}const o=["field","type","description"],r=["value","description"];class l{constructor(e,t={}){this.options=Object.assign({},{save:!0,mandatory:!1},t),this.tableWrapDom=e,this.columns={},this.dataSource=[],this.domId=e.getAttribute("data-uid")||Date.now().toString(26).slice(-5)+Math.random().toString(26).slice(-5),e.setAttribute("data-uid",this.domId),this.options.save&&l.tsTableList.set(this.domId,this),window.BaseTsTable=l}init(){this.tsType||(this.initColums(),this.tsType=function(e){const t=Object.values(e||{});return o.every((e=>t.includes(e)))?"interface":!!r.every((e=>t.includes(e)))&&"enum"}(this.columns),!1!==this.tsType&&(this.initDataSource(),this.initTypeName()))}initColums(){const e=this.tableWrapDom.querySelector("tr");if(!e)return;e.querySelectorAll("th").forEach(((e,t)=>{const n=e.innerText.trim().toLowerCase();this.columns[t]=n}))}initDataSource(){(function(e){const t=e.classList.value;return Array.from(e.querySelectorAll("tr")).filter((n=>{let i=n.parentElement;for(;i;){if(i.classList.contains(t))return i===e;i=i.parentElement}return!0}))})(this.tableWrapDom).forEach((i=>{const s=Array.from(i.children).filter((e=>"td"===e.nodeName.toLowerCase()));if(!s.length)return;const a={};s.forEach(((i,s)=>{var o,r;const c=this.columns[s];if(!c)return;let d="";if(i.childElementCount){const t=i.querySelector(".table-wrap");if(t){const i=t.getAttribute("data-uid");if(i&&l.tsTableList.has(i)){const t=l.tsTableList.get(i);null==t||t.init(),d=`type:${function(t=[]){const i=[];return t.forEach((t=>{if(!t.field)return;let s=`${e(t.field)}${t.mandatory?"":"?"}: ${n(t.type)}`;i.push(s)})),`{ ${i.join("; ")} }`}((null==t?void 0:t.dataSource)||[])}`}}else d=null===(r=i.innerText.split("\n")[0])||void 0===r?void 0:r.trim()}else d=null===(o=i.innerText)||void 0===o?void 0:o.trim();if("type"===c){const n=i.querySelector("a");if(n){const i=n.href.replace(/\#.*/,"");let s=n.innerText.trim();if(/[\-_\s]+(.)?/g.test(s)){let n=s;s=t(e(s)),d=d.replace(n,s)}-1!==location.href.indexOf(i)||l.referenceTypes.has(s)||l.referenceTypes.set(s,{href:i})}}if(a[c]=d.trim(),this.options.mandatory&&"mandatory"===c&&i.innerHTML){const e=i.querySelector("img");e&&e.src&&/check\.svg$/.test(e.src)&&(a[c]=!0)}})),this.dataSource.push(function(e={}){if((!e.type||/^(object|Object|obj|Obj)/.test(e.type))&&/^type\:/.test(e.description)){const t=e.description.replace("type:","");return e.type=e.type?e.type.replace(/object|Object|obj|Obj/,t):t,e.description="",e}if(/^type\:/.test(e.type))return e.type=e.type.replace("type:",""),e;return e}(a))}))}initTypeName(){if(this.tsType){let n=2,i=this.tableWrapDom;for(;n>0;){n--;const s=i.previousElementSibling;if(s){if(s.classList.contains("code"))break;let n=s.innerText.trim();if(n){/([a-zA-Z\s]+)/.test(n)&&(n=RegExp.$1),this.typeName=t(e(n));break}}if(i=s,!i)break}this.typeName&&/^[A-Za-z0-9]+$/g.test(this.typeName)||(this.typeName=`Type${t(this.domId)}`)}else this.typeName=""}updateTypeName(e){e&&(this.typeName=e)}generateTsType(){if(this.init(),!this.tsType)return"";if(l.typeMap.has(this.typeName))return l.typeMap.get(this.typeName);const t=function(t,i,s=[]){switch(t){case"interface":return function(t,i=[]){const s=[];return i.forEach((t=>{if(!t.field)return;let i=`${e(t.field)}${t.mandatory?"":"?"}: ${n(t.type)}`;t.description&&(i+=` // ${t.description.replace(/\n/g,"")}`),s.push(i)})),`export interface ${t} {\n  ${s.join("\n  ")}\n}`}(i,s);case"enum":return function(e,t=[]){const n=[];return t.forEach((e=>{var t;(e.type||e.description)&&e.value&&n.push(`${(e.type||e.description).replace(/[\s\-\/]+/g,"_")} = ${t=e.value,isNaN(Number(t))?"true"===t||"false"!==t&&t:Number(t)}`)})),`export enum ${e} {\n  ${n.join(",\n  ")}\n}`}(i,s);default:return""}}(this.tsType,this.typeName,this.dataSource);return l.typeMap.set(this.typeName,t),t}static getAllReferenceTypeOrigin(){const e={};return l.referenceTypes.forEach((t=>{const{href:n,fetch:i}=t;!i&&(e[n]=n)})),Object.values(e)}static getAllReferenceTypes(){const e={};return l.referenceTypes.forEach(((t,n)=>{l.typeMap.has(n)&&(e[n]=l.typeMap.get(n))})),Object.values(e).reduce(((e,t)=>(/^export\s+enum/.test(t)?e.unshift(t):e.push(t),e)),[])}}l.typeMap=new Map,l.tsTableList=new Map,l.referenceTypes=new Map;class c extends l{constructor(e,t={}){super(e,t),this.tableWrapDom.addEventListener("mouseenter",this.handleMouseenter.bind(this)),this.tableWrapDom.addEventListener("mouseleave",this.handleMouseLeave.bind(this))}handleMouseenter(){if(this.tsType||this.init(),!1===this.tsType)return;this.triggerDom||this.initTrigger();const e=this.tableWrapDom.querySelector(".confluenceTable");this.triggerDom.innerText="copy",this.triggerDom.style.left=e.offsetWidth+"px",this.triggerDom.style.display="block"}handleMouseLeave(){this.triggerDom&&(this.triggerDom.style.display="none")}initTrigger(){this.tableWrapDom.style.position="relative",this.triggerDom=s("div","position:absolute;top:0px;z-index:10;background:#ddd;display:none;font-size:12px;padding:2px 5px;color:#666;border-radius:5px;cursor:pointer;"),this.triggerDom.addEventListener("click",(()=>{const e=this.generateTsType();i(e).then((()=>{this.triggerDom.innerText="copied"}))})),this.tableWrapDom.appendChild(this.triggerDom)}}const d=/^(GET|POST|DELETE|PUT|get|post|delete|put)\s+\/api/;class p{constructor(){if(p.instance)return p.instance;this.init(),p.instance=this,window.tsapi=p.instance}init(){this.initApiDoms()}initApiDoms(){if(!this.apiDoms){this.apiDoms=function(){const e=document.querySelectorAll('div[data-macro-name="code"]'),t=[];return e.forEach((e=>{const n=e.innerText.trim();!n||n.split("\n").length>1||d.test(n)&&t.push(e)})),t}();for(let e=0;e<this.apiDoms.length;e++)this.handleApiDom(this.apiDoms[e])}}handleApiDom(n){if(!n)return;const i=function(t){const n=t.indexOf("/api");if(-1===n)return{};const i=[],s=t.indexOf("?"),a=t.slice(n,-1===s?t.length:s);let o=a;const r=/\:([a-z-_]+)/.exec(o);if(r&&r[1]){const t=e(r[1]);o=o.replace(r[0],`\${${t}}`),i.push({name:t,type:"string"})}return{url:o,originUrl:a,name:u(t),method:h(t),args:i}}(n.innerText.trim()),s=Object.assign({},i);let a=0,o=n.previousElementSibling;for(;o&&a<2;){if(/^h[1-6]$/.test(o.nodeName.toLowerCase())){const e=o.innerText.trim();if(!/request/.test(e.toLowerCase())){s.label=e;break}}o=o.previousElementSibling,a++}let r=n.nextElementSibling,l=!1;for(;r;){const e=r.innerText.trim();if(e){if(d.test(e))break;if(/response/.test(e.toLowerCase()))l=!0,r=r.nextElementSibling;else{if(r.classList.contains("table-wrap")){const e=new c(r,{mandatory:!0,save:!1});e.init(),e.updateTypeName(t(`${s.name}${l?"Response":"Request"}`));const n={typeName:e.typeName,typeDeclaration:e.generateTsType()};if(l){s.responseType=n;break}s.requestBody=n}r=r.nextElementSibling}}else r=r.nextElementSibling}n.ts=s}generateAllApiCode(){const e=[];return this.apiDoms.forEach((t=>{const n=t.ts;n&&e.push(function(e){var t;const{args:n=[],responseType:i,requestBody:s}=e,a=(null==n?void 0:n.map((e=>`${e.name}: ${e.type}`)))||[],o=[];let r="";(null==s?void 0:s.typeDeclaration)&&(a.push(`data: ${s.typeName}`),o.push(s.typeDeclaration),r="get"===e.method?"params: data":"data");(null==i?void 0:i.typeDeclaration)&&o.push(i.typeDeclaration);return`${o.length>0?"\n"+o.join("\n\n")+"\n":""}\n/**\n * ${e.label}\n * @method ${e.method}\n * @url ${e.originUrl} \n */\nexport async function ${e.name}(${a.join(", ")}): Promise<${(null==i?void 0:i.typeName)||"any"}> {\n  return request(\`${null===(t=e.url)||void 0===t?void 0:t.replace(/^\/api/,"")}\`, {\n    method: '${e.method}',${r?`\n    ${r},`:""}\n  })\n}`}(n))})),e.length>0&&e.unshift("import request from '@/utils/request'"),e.join("\n")}}function h(e){const t=d.exec(e);return t&&t[1]?t[1].toLowerCase():"get"}function u(t){const n=h(t),i=t.replace(/\?.+/,"").split("/").filter((e=>!/^\:/.test(e)));let s=i.length-1,a=e(`${n} ${i.slice(s).join(" ")}`);for(;p.apiNameMap.has(a)&&s>0;)s--,a=e(`${n} ${i.slice(s).join(" ")}`);return p.apiNameMap.set(a,1),a}p.apiNameMap=new Map;class f{initModal(){if(this.modal)return;this.modal=s("div","position:fixed;top:0;left:0;z-index:1000;width:100%;height:100%;display:none");const e=s("div","position:absolute;top:50%;left:40%;width:600px;height:80%;min-height:500px;padding:12px;background:#f5f5f5;border:1px solid #ddd;overflow:auto;transform:translate(-50%,-50%);");this.textarea=s("textarea","width:100%;height:100%;font-size:14px;resize:none;border:0;background:#f5f5f5;outline:none;"),this.textarea.readOnly=!0;const t=s("div","position:absolute;top:0px;right:0px;width:40px;height:30px;line-height:30px;font-size:20px;text-align:center;color:#666;background:#ddd;cursor:pointer;");t.innerText="X",t.addEventListener("click",(()=>{this.hidden()}));const n=s("div","position:absolute;top:31px;right:0px;width:40px;height:30px;line-height:30px;font-size:20px;text-align:center;color:#666;background:#ddd;cursor:pointer;");n.innerText="C",n.addEventListener("click",(()=>{i(this.textarea.value)})),e.appendChild(this.textarea),e.appendChild(t),e.appendChild(n),this.modal.appendChild(e),document.body.appendChild(this.modal)}initExtraWrap(){if(this.extraWrap)return;this.extraWrap=s("div","position:absolute;top:50%;right:0;width:400px;height:40%;min-height:400px;padding:12px;background:#f5f5f5;border:1px solid #ddd;overflow:auto;transform: translateY(-50%);"),this.extraTextarea=s("textarea","width:100%;height:100%;font-size:12px;resize:none;border:0;background:#f5f5f5;outline:none;"),this.extraTextarea.readOnly=!0;const e=s("div","position:absolute;top:0;right:0px;width:40px;height:30px;line-height:30px;font-size:20px;text-align:center;color:#666;background:#ddd;cursor:pointer;");e.innerText="C",e.addEventListener("click",(()=>{i(this.extraTextarea.value)})),this.extraWrap.appendChild(this.extraTextarea),this.extraWrap.appendChild(e),this.modal.appendChild(this.extraWrap)}show(){this.modal||this.initModal(),this.modal.style.display="block"}hidden(){this.modal&&(this.modal.style.display="none")}updateValue(e){this.textarea&&(this.textarea.value=e)}updateExtraValue(e){this.extraWrap||this.initExtraWrap(),this.extraTextarea&&(this.extraTextarea.value=e),this.extraWrap.style.display=e?"block":"none"}}class m{constructor(e){this.cbs={},this.worker=new Worker(e),this.worker.addEventListener("message",(e=>{const{event:t,data:n}=e.data;this.cbs[t]&&this.cbs[t].forEach((e=>{e(n)}))}))}on(e,t){if("function"!=typeof t)return;const n=this.cbs[e]||[];n.push(t),this.cbs[e]=n}emit(e,t){this.worker.postMessage({event:e,data:t})}destory(){this.worker&&this.worker.terminate()}}m.generateWorkerBlob=e=>{const t=new Blob([`~(${e.toString()})();`],{type:"text/javascript"});return window.URL.createObjectURL(t)};class y{constructor(){if(y.instance)return y.instance;this.initTsButton(),this.initTsApiButton(),y.instance=this}initTsButton(){this.tsButton=s("div","position:fixed;right:20px;bottom:20px;z-index:10;background:#ddd;font-size:12px;padding:2px 5px;color:#666;border-radius:5px;cursor:pointer;"),this.tsButton.innerText="生成ts",this.tsButton.addEventListener("click",this.handleButtonClick.bind(this)),document.body.appendChild(this.tsButton)}initTsApiButton(){this.tsApiButton=s("div","position:fixed;right:20px;bottom:45px;z-index:10;background:#ddd;font-size:12px;padding:2px 5px;color:#666;border-radius:5px;cursor:pointer;"),this.tsApiButton.innerText="生成api",this.tsApiButton.addEventListener("click",this.handleApiButtonClick.bind(this)),document.body.appendChild(this.tsApiButton)}initWorker(){this.worker||(this.worker=new m(m.generateWorkerBlob(g)),this.worker.on("fetchDocument:response",(e=>{if(!e)return;for(const t in e){a(e[t]).querySelectorAll(".table-wrap").forEach((e=>{new l(e,{save:!1}).generateTsType()})),c.referenceTypes.forEach(((e,n)=>{const{href:i}=e;i===t&&c.referenceTypes.set(n,Object.assign(Object.assign({},e),{fetch:!0}))}))}const t=y.generateAllReferenceTypes();this.modal.updateExtraValue(t)})))}handleButtonClick(){this.modal||(this.modal=new f),this.modal.show(),this.modal.updateValue(y.generateAllTsTypes()),this.fetchAllReferenceTypes()}handleApiButtonClick(){const e=new p;this.modal||(this.modal=new f),this.modal.show(),this.modal.updateValue(e.generateAllApiCode()),this.fetchAllReferenceTypes()}fetchAllReferenceTypes(){const e=c.getAllReferenceTypeOrigin();if(e.length>0)this.worker||this.initWorker(),this.worker.emit("fetchDocument",e);else{const e=y.generateAllReferenceTypes();this.modal.updateExtraValue(e)}}static generateAllTsTypes(){const e=[];return c.tsTableList.forEach((t=>{const n=t.generateTsType();n&&("enum"===t.tsType?e.unshift(n):e.push(n))})),e.join("\n\n")}static generateAllReferenceTypes(){return c.getAllReferenceTypes().join("\n\n")}}function g(){function e(t){return new Promise((n=>{e.cache[t]?n(e.cache[t]):fetch(t,{method:"get"}).then((i=>{i.text().then((i=>{e.cache[t]=i?function(e){if(!e)return"";const t=e.split("\n").map((e=>e.trim())).filter((e=>e)),n=t.findIndex((e=>/id="main"/.test(e))),i=t.findIndex((e=>/<!-- \\#main -->/.test(e)));return-1===n||-1===i?e:t.slice(n,i+1).join("")}(i):"<div></div>",n(e.cache[t])})).catch((()=>{e.cache[t]="<div></div>",n(e.cache[t])}))})).catch((()=>{e.cache[t]="<div></div>",n(e.cache[t])}))}))}e.cache={};const t={fetchDocument:(t=[])=>new Promise(((n,i)=>{var s;(s=t.map((t=>e(t))),new Promise((e=>{const t=Array(s.length);let n=0;s.forEach(((i,a)=>{i.then((e=>{t[a]=e})).catch((()=>{t[a]=void 0})).finally((()=>{n++,n===s.length&&e(t)}))}))}))).then((e=>{n(e.reduce(((e,n,i)=>(e[t[i]]=n,e)),{}))}))}))};self.addEventListener("message",(e=>{const{data:n,event:i}=e.data;t[i]&&t[i](n).then((t=>{self.postMessage({event:`${e.data.event}:response`,data:t})}))}))}function x(){/resumedraft/.test(location.href)&&(function(){const e=s("button","position:fixed;top:200px;right:0px;z-index:999;width:80px;");e.innerText="API",e.addEventListener("click",(()=>{var e;const t=null===(e=null===window||void 0===window?void 0:window.tinymce)||void 0===e?void 0:e.editors[0];console.log("api: ",t),null==t||t.insertContent(`<h1>接口名称</h1><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="8bfb996f-1108-403f-a3bf-e188372757ca" data-macro-schema-version="1" data-macro-body-type="PLAIN_TEXT" style="background-image: url(https://confluence.shopee.io/plugins/servlet/confluence/placeholder/macro-heading?definition=e2NvZGV9&amp;locale=zh_CN&amp;version=2); background-repeat: no-repeat"><tbody><tr><td class="wysiwyg-macro-body"><pre>POST /api/xxx/xxx</pre></td></tr></tbody></table><h2>Request</h2><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="aee3ad21-d02f-4d62-a835-2d18246931ba" data-macro-schema-version="1" data-macro-body-type="PLAIN_TEXT" style="background-image: url(https://confluence.shopee.io/plugins/servlet/confluence/placeholder/macro-heading?definition=e2NvZGV9&amp;locale=zh_CN&amp;version=2); background-repeat: no-repeat"><tbody><tr><td class="wysiwyg-macro-body"><pre>{...}</pre></td></tr></tbody></table>${b}<h2>Response</h2><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="aee3ad21-d02f-4d62-a835-2d18246931ba" data-macro-schema-version="1" data-macro-body-type="PLAIN_TEXT" style="background-image: url(https://confluence.shopee.io/plugins/servlet/confluence/placeholder/macro-heading?definition=e2NvZGV9&amp;locale=zh_CN&amp;version=2); background-repeat: no-repeat"><tbody><tr><td class="wysiwyg-macro-body"><pre>{...}</pre></td></tr></tbody></table>${b}`)})),document.body.appendChild(e)}(),function(){const e=s("button","position:fixed;top:230px;right:0px;z-index:999;width:80px;");e.innerText="Structure",e.addEventListener("click",(()=>{var e;const t=null===(e=null===window||void 0===window?void 0:window.tinymce)||void 0===e?void 0:e.editors[0];null==t||t.insertContent(`<h2>StructureName</h2>${b}`)})),document.body.appendChild(e)}(),function(){const e=s("button","position:fixed;top:260px;right:0px;z-index:999;width:80px;");e.innerText="Enum",e.addEventListener("click",(()=>{var e;const t=null===(e=null===window||void 0===window?void 0:window.tinymce)||void 0===e?void 0:e.editors[0];null==t||t.insertContent('<h2>EnumName</h2><table class="wrapped confluenceTable"><colgroup><col><col></colgroup><thead><tr><th class="confluenceTh" style="text-align: left"><p>Value</p></th><th class="confluenceTh" style="text-align: left"><p>Description</p></th></tr></thead><tbody><tr><td class="confluenceTd" style="text-align: left"></td><td class="confluenceTd" style="text-align: left"></td></tr><tr><td class="confluenceTd" style="text-align: left"></td><td class="confluenceTd" style="text-align: left"></td></tr></tbody></table>')})),document.body.appendChild(e)}())}const b='<table class="relative-table wrapped confluenceTable" style="width: 0.0px"><thead><tr><th class="confluenceTh" style="text-align: left"><p>Field</p></th><th class="confluenceTh" style="text-align: left"><p>Type</p></th><th class="confluenceTh" style="text-align: left"><p>Description</p></th><th class="confluenceTh" style="text-align: left"><p>Example</p></th><th class="confluenceTh" style="text-align: left"><p>Mandatory</p></th></tr><tr><td colspan="1" class="confluenceTd" style="text-align: left"></td><td colspan="1" class="confluenceTd" style="text-align: left"></td><td colspan="1" class="confluenceTd" style="text-align: left"></td><td colspan="1" class="confluenceTd" style="text-align: left"></td><td colspan="1" class="confluenceTd" style="text-align: left"></td></tr><tr><td colspan="1" class="confluenceTd" style="text-align: left"></td><td colspan="1" class="confluenceTd" style="text-align: left"></td><td colspan="1" class="confluenceTd" style="text-align: left"></td><td colspan="1" class="confluenceTd" style="text-align: left"></td><td colspan="1" class="confluenceTd" style="text-align: left"></td></tr></thead></table>';setTimeout((function(){if(!/confluence\.shopee\.io/.test(location.host))return;document.querySelectorAll(".table-wrap").forEach((e=>{new c(e)})),new y,x()}),1e3)}();
