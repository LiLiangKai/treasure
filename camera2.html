<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
    <div>
      <label for="imageFile">Upload a photo of yourself:</label>
      <input type="file" id="imageFile" capture="user" accept="image/*">
    </div>
    <div>
      <button onclick="scanBarCode()">barCodde</button>
      <button onclick="scanQrCode()">QrCodde</button>
    </div>
    <canvas id="canvas" style="display: block"></canvas>

    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <script src="https://cozmo.github.io/jsQR/jsQR.js"></script>
    <script>
      new window.VConsole()
      const canvas = document.getElementById('canvas')
      const context = canvas.getContext('2d')
      const imageFile = document.getElementById('imageFile')
      let decodeType = 'qrcode'

      imageFile.addEventListener('change', fileChange)

      function fileChange (e) {
        console.log(e.target.files)
        const file = e.target.files[0]
        var reader = new FileReader();    
        reader.readAsDataURL(file);    
          //监听文件读取结束后事件    
        reader.onloadend = function (e) {
          readImg(e.target.result)
        };
      }

      function readImg (base64) {
        const image = new Image()
        image.onload = () => {
          const { width, height } = image
          const canvasWidth = Math.min(400, window.innerWidth, width)
          const ratio = width / height
          canvas.width = canvasWidth
          canvas.height = (canvasWidth / ratio) >> 0
          console.log('size: ', canvas.width, canvas.height)
          context.drawImage(image,0,0,image.width,image.height,0,0,canvas.width,canvas.height)
          if(decodeType === 'qrcode') {
            decodeQrCode()
          } else {
            decodeBarCode()
          }
        }
        image.src = base64
      }

      function decodeQrCode () {
        const width = canvas.width
        const height = canvas.height
        const imageData = context.getImageData(0, 0, width, height);
        readQrcode(imageData.data, width, height);
      }

      function readQrcode(data, width, height){
        let code = jsQR(data, width, height, {
          inversionAttempts: "dontInvert",
        });

        if (code){
          console.log('ondata',code); 
          alert('qrcode data: ' + code.data)
        } else {
          console.log('识别失败')
        }
      }

      function decodeBarCode () {
        readBarcode(canvas.toDataURL());
      }
      function readBarcode(imgBase64){
        Quagga.decodeSingle({
          decoder: {
            readers: [
              'code_128_reader',
              'ean_reader'
            ]
          },
          multiple: false,
          src: imgBase64
        }, function(result){
          if (result){
            if(result.codeResult) {
              console.log(result.codeResult);
              alert("扫码成功，结果是: "+result.codeResult.code);
            } else {
              console.log('识别失败')
            }
          } else {
            console.log('识别失败')
          }
        });
      }

      function scanQrCode () {
        decodeType = 'qrcode'
        console.log('decodeType: ', decodeType)
      }
      function scanBarCode () {
        decodeType = 'barcode'
        console.log('decodeType: ', decodeType)
      }
    </script>
</body>
</html>
