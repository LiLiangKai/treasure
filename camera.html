<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }
    #scanner {
      position: fixed;
      width: 100%;
      height: 100%;
      z-index: 10;
      background-color: rgba(0,0,0,.2);
    }
    .scanner-inner {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      width: 100%;
      height: 100%;
    }
    .topbar {
      height: 25%;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .scan {
      position: relative;
      height: 50%;
    }
    .scan-view {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      max-width: 263px;
      max-height: 263px;
      box-shadow: 0 0 10000px 10000px rgb(0 0 0 / 20%);
      overflow: hidden;
    }
    .scan-border {
      position: absolute;
      width: 28px;
      height: 28px;
      border: 4px solid #EE4D2D;
    }
    .scan-border.lt {
      top: 0;
      left: 0;
      border-right: 0;
      border-bottom: 0;
    }
    .scan-border.lb {
      bottom: 0;
      left: 0;
      border-right: 0;
      border-top: 0;
    }
    .scan-border.rt {
      top: 0;
      right: 0;
      border-bottom: 0;
      border-left: 0;
    }
    .scan-border.rb {
      right: 0;
      bottom: 0;
      border-left: 0;
      border-top: 0;
    }
    .scan-line {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 92px;
      transform: translateY(-100%);
      background: linear-gradient(180deg, #EE4D2D 0%, rgba(255, 255, 255, 0.0001) 62.71%);
      mix-blend-mode: normal;
      opacity: 0.6;
      animation: scanLine 5s linear infinite alternate;
      animation-fill-mode: both
    }
    @keyframes  scanLine{
      0% {
        transform: translateY(-100%) matrix(1, 0, 0, -1, 0, 0);
      }
      80% {
        transform: translateY(250%) matrix(1, 0, 0, -1, 0, 0)
      }
      100% {
        transform: translateY(260%) matrix(1, 0, 0, 1, 0, 0);
      }
    }
    .operate {
      height: 25%;
    }
    #video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      background-color: #fff;
    }
    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      background-color: #f5f5f5;
    }
  </style>
</head>
<body>
  <div id="scanner">
    <video id="video" autoplay playsinline="true" webkit-playsinline="true"></video>
    <div class="scanner-inner">
      <div class="topbar">
        <div class="topbar-left"></div>
        <div class="topbar-right">
          <div class="facing-mode">前置</div>
        </div>
      </div>
      <div class="scan">
        <div class="scan-view">
          <div class="scan-border lt"></div>
          <div class="scan-border lb"></div>
          <div class="scan-border rt"></div>
          <div class="scan-border rb"></div>
          <div class="scan-line"></div>
        </div>
      </div>
      <div class="operate"></div>
    </div>
    <canvas id="canvas" style="display: none"></canvas>
  </div>
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
  <script src="https://cozmo.github.io/jsQR/jsQR.js"></script>

  <script>
    new window.VConsole()

    const scanView = document.querySelector('.scan-view')
    const facingModeDom = document.querySelector('.facing-mode')
    const canvas = document.getElementById('canvas')
    const context = canvas.getContext('2d')
    const video = document.querySelector('#video')
    let cameraWidth
    let cameraHeight
    let useRearCamera = false
    let decodeing = false
    let decodeType = 'qrcode'
    let timer

    function resizeWindow() {
      const size = scanView.offsetWidth
      scanView.style.height = size + 'px'
    }

    function openCamera(constrains){
      if(navigator.mediaDevices.getUserMedia){
        //最新标准API
        navigator.mediaDevices.getUserMedia(constrains).then(videoSuccess).catch(videoError);
      } else if (navigator.webkitGetUserMedia){
        //webkit内核浏览器
        navigator.webkitGetUserMedia(constrains).then(videoSuccess).catch(videoError);
      } else if (navigator.mozGetUserMedia){
        //Firefox浏览器
        navagator.mozGetUserMedia(constrains).then(videoSuccess).catch(videoError);
      } else if (navigator.getUserMedia){
        //旧版API
        navigator.getUserMedia(constrains).then(videoSuccess).catch(videoError);
      } else {
        console.log("你的浏览器不支持访问用户媒体设备")
      }
    }

    function videoError(error){
      console.log("访问用户媒体设备失败：",error);
    }

    function videoSuccess(stream) {
      //将视频流设置为video元素的源
      video.srcObject = stream;
      //播放视频
      video.play()

      video.oncanplay = function () {
        // 摄像头分辨率,手机480x640
        console.log('摄像头分辨率');
        console.log(video.videoWidth,video.videoHeight);
        cameraWidth = video.videoWidth;
        cameraHeight = video.videoHeight;
        canvas.width = cameraWidth
        canvas.height = cameraHeight
        // 发送图片进行识别
        readImg();
      };
    }

    function readImg(){
      const handle = () => {
        if(decodeing) return
        context.drawImage(video,0,0,cameraWidth,cameraHeight,0,0,cameraWidth,cameraHeight);
        if(decodeType === 'qrcode') {
          decodeQrCode()
        }
        timer = setTimeout(handle,1000)
      }
      timer = setTimeout(handle,1000)
    }

    // 扫码二维码
    function decodeQrCode () {
      decodeing = true
      imageData = context.getImageData(0, 0, cameraWidth, cameraHeight);
      readQrcode(imageData.data,timer);
    }

    function readQrcode(data,timer){
      let code = jsQR(data, cameraWidth, cameraHeight, {
        inversionAttempts: "dontInvert",
      });

      if (code){
        console.log('ondata',code); 
      }
      decodeing = false
    }

    function initVideo () {
      clearTimeout(timer)
      video.pause()
      openCamera({
        video: {
          facingMode: !useRearCamera ? 'user' : {
            exact: "environment"
          }
        }
      })
    }

    function switchCameraMode () {
      useRearCamera = !useRearCamera
      facingModeDom.innerText = useRearCamera ? '后置' : '前置'
      initVideo()
    }

    function init () {
      window.addEventListener('resize', resizeWindow)
      facingModeDom.addEventListener('click', switchCameraMode)
      resizeWindow()
      initVideo()
    }

    init()
  </script>
</body>
</html>
