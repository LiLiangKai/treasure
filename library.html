<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    * {
      padding: 0;
      margin: 0;
    }
    .video-wrap {
      width: 100%;
      height: 100%;
      overflow: auto;
    }
    button {
      min-width: 90px;
      height: 32px;
    }
  </style>
</head>
<body>
  <div style="border-bottom: 1px solid #ddd;padding-bottom: 20px;margin-bottom: 20px;">
    <button onclick="switchMode('barcode')">barCode</button>
    <button onclick="switchMode('qrcode')">qrCode</button>
    <button onclick="switchMode('all')">all</button>
    <br>
    <span id="curMode"></span>
  </div>
  <div>
    <button id="start">start</button>
    <button id="stop">stop</button>
  </div>
  <div class="video-wrap">
    <video id="video" width="600" height="400" style="border: 1px solid gray"></video>
  </div>
  <div>result: <span id="result"></span></div>
  <div>
    <p>select one camera</p>
    <p>
      <select id="sourceSelect" style="max-width:400px"></select>
    </p>
    <button id="noSelect">no select camera</button>
  </div>
<script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
<script>
  new window.VConsole()
  const deviceIds = []
  const video = document.getElementById('video')
  const startBtn = document.getElementById('start')
  const stopBtn = document.getElementById('stop')
  const sourceSelect = document.getElementById('sourceSelect')
  const noSelectBtn = document.getElementById('noSelect')
  const resultDom = document.getElementById('result')
  let codeReader
  let loaded = false
  let scaning = false
  let selectedDeviceId
  
  
  function initMultiFormatReader () {
    const hints = new Map()
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.QR_CODE, ZXing.BarcodeFormat.CODE_128])
    codeReader = new ZXing.BrowserMultiFormatReader(hints,1000)
    console.log('ZXing BrowserMultiFormatReader reader initialized')
    codeReader.listVideoInputDevices().then(updateVideoInputDevices)
  }

  function initBarCodeReader () {
    const hints = new Map()
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.CODE_128])
    codeReader = new ZXing.BrowserBarcodeReader(1000,hints)
    console.log('ZXing BrowserBarcodeReader reader initialized')
    codeReader.getVideoInputDevices().then(updateVideoInputDevices)
  }

  function initQrCodeRender () {
    codeReader = new ZXing.BrowserQRCodeReader(1000)
    console.log('ZXing BrowserQRCodeReader reader initialized')
    codeReader.listVideoInputDevices().then(updateVideoInputDevices)
  }

  function updateVideoInputDevices (videoInputDevices) {
    console.log('videoInputDevices: ', videoInputDevices)
    if(videoInputDevices.length > 0) {
      sourceSelect.innerHTML = ''
      videoInputDevices.forEach(item => {
        deviceIds.push({
          value: item.deviceId,
          label: item.label
        })
        const sourceOption = document.createElement('option')
        sourceOption.text = item.label
        sourceOption.value = item.deviceId
        sourceSelect.appendChild(sourceOption)
      })
      selectedDeviceId = deviceIds[0].value
    }
    loaded = true
  }

  function startScan () {
    if(!loaded || scaning) return
    if(!deviceIds.length) {
      throw 'not found any Video Device'
    }
    console.log('use device: ', selectedDeviceId)
    codeReader.decodeFromVideoDevice(selectedDeviceId, video, (result, error) => {
      if(result) {
        console.log('decode result: ', result)
        alert(result.text)
        resultDom.innerText = result.text
      }
      if(error && !(error instanceof ZXing.NotFoundException)) {
        console.log('error: ', error)
      }
    })
    scaning = true
  }

  function stop () {
    scaning = false
    codeReader && codeReader.reset()
    video.pause()
  }

  startBtn.addEventListener('click', startScan)
  stopBtn.addEventListener('click', stop)
  noSelectBtn.addEventListener('click', () => {
    sourceSelect.value = ''
    selectedDeviceId = ''
  })
  sourceSelect.addEventListener('change', () => {
    selectedDeviceId = sourceSelect.value
  })
  video.addEventListener('canplay', () => {
    console.log('视频分辨率: ', video.videoWidth, video.videoHeight)
  })

  function switchMode (mode) {
    stop()
    loaded = false
    curMode.innerText = mode
    switch(mode) {
      case 'barcode':
        return initBarCodeReader()
      case 'qrcode':
        return initQrCodeRender()
      case 'all':
        return initMultiFormatReader()
    }
  }

</script>
</body>
</html>
